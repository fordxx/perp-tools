# PerpBot V2 开发路线图

**文档版本**: 1.0
**创建日期**: 2025-12-12
**项目状态**: ✅ 核心功能已完成（99/100 验证分数）

---

## 📊 当前项目状态

### 系统成熟度
- **验证分数**: ✅ **99.0/100** (47/48 测试通过)
- **核心架构**: ✅ **100%** 完成（EventBus、执行引擎、风控、资金管理）
- **交易所支持**: ✅ **9个交易所**全部集成
- **代码规模**: ~18,000 行生产级代码
- **文档质量**: 20+ 份文档，总计 190KB

### 完成的模块

| 模块 | 状态 | 说明 |
|------|------|------|
| EventBus | ✅ 100% | 事件驱动核心 |
| RiskManager | ✅ 100% | 四层纵深风控 |
| ExecutionEngine V2 | ✅ 100% | 智能执行引擎 |
| PositionAggregator V2 | ✅ 100% | 实时敞口追踪 |
| CapitalSystem V2 | ✅ 100% | 三层资金管理 |
| HealthMonitor | ✅ 100% | 健康监控与告警 |
| ConsoleState | ✅ 100% | 状态聚合 |
| 9个交易所客户端 | ✅ 100% | Paradex/Extended/OKX/Lighter/EdgeX/Backpack/GRVT/Aster/Hyperliquid |
| Web/CLI Dashboard | ✅ 100% | 可视化监控 |

### 待完成的关键任务

| 功能 | 优先级 | 状态 |
|------|-------|------|
| 真实交易所数据集成 | 🔴 高 | ⏳ Scanner V3 需要真实行情 |
| 全系统集成 Demo | 🔴 高 | ⏳ 缺少端到端演示 |
| 生产环境部署脚本 | 🟠 中 | ⏳ Docker/监控配置 |
| 性能压测 | 🟠 中 | ⏳ 高并发测试 |
| 单元测试覆盖 | 🟠 中 | ⏳ 覆盖率提升 |
| 高级执行策略 | 🟡 低 | ⏳ TWAP/VWAP |

---

## 🎯 推进方向（按优先级排序）

### 🔴 最高优先级 - 立即行动

#### 1. 真实交易所数据集成与实战验证 ⭐⭐⭐⭐⭐

**当前状态**: Scanner V3 仅通过 50% 验证（缺少真实行情数据）

**核心问题**:
- 系统所有模块都验证通过了，但还没有接入真实的市场数据
- 无法验证套利机会在真实市场中是否存在
- 无法测试真实环境下的性能表现

**工作内容**:
- [ ] 接入 Paradex WebSocket 行情
- [ ] 接入 OKX WebSocket 行情
- [ ] 接入 Hyperliquid WebSocket 行情
- [ ] 实现行情数据归一化处理
- [ ] 验证套利发现的准确性和延迟
- [ ] 压测行情处理性能（目标处理延迟 < 100ms）
- [ ] 在真实市场条件下测试完整交易流程
- [ ] 记录实际套利机会的频率和规模

**价值**:
- 🎯 这是从"验证通过"到"真实可用"的**关键一跳**
- 🎯 能发现真实环境中的性能瓶颈
- 🎯 验证套利机会的实际可行性
- 🎯 为后续优化提供真实数据支持

**工作量**: 2-3 天

**技术难点**:
- WebSocket 连接管理（断线重连、心跳检测）
- 行情数据归一化（不同交易所格式不同）
- 延迟优化（网络延迟、处理延迟）
- 数据一致性保证

**验收标准**:
- ✅ Scanner V3 验证分数达到 100%
- ✅ 行情处理延迟 < 100ms (P99)
- ✅ 能够实时发现套利机会
- ✅ 系统在真实行情下稳定运行 24 小时+

**相关文件**:
- `src/perpbot/scanner/market_scanner_v3.py`
- `src/perpbot/scanner/pair_scanner.py`
- `src/perpbot/exchanges/paradex.py`
- `src/perpbot/exchanges/okx.py`
- `src/perpbot/exchanges/hyperliquid.py`

---

#### 2. 完整端到端 Demo ⭐⭐⭐⭐

**当前状态**: 各模块独立验证通过，但缺少完整流程演示

**核心问题**:
- 新用户不知道如何把所有模块串起来使用
- 缺少直观的系统使用示例
- 学习曲线陡峭

**工作内容**:
- [ ] 编写 `demos/full_system_demo.py` 展示完整交易流程
  - 系统初始化（EventBus、风控、执行引擎等）
  - 资金系统初始化（洗量/套利/储备资金分配）
  - 订阅多个交易所行情
  - 实时发现套利机会
  - 风控检查流程
  - 执行下单（开仓）
  - 监控持仓状态
  - 平仓止盈/止损
  - 系统关闭与资源清理
- [ ] 添加详细的注释和日志输出
- [ ] 编写配套的快速入门文档 `docs/QUICK_START.md`
- [ ] 创建示例配置文件 `config.demo.yaml`

**价值**:
- 🎯 让新用户能在 **30 分钟内**理解并运行系统
- 🎯 提升项目的可用性和传播性
- 🎯 方便招募开发者或展示给潜在用户
- 🎯 作为集成测试的参考实现

**工作量**: 1-2 天

**验收标准**:
- ✅ Demo 可以一键运行（`python demos/full_system_demo.py`）
- ✅ 覆盖完整的交易生命周期
- ✅ 有清晰的日志输出，展示每个步骤
- ✅ 配套文档让零基础用户能跑起来

**输出文件**:
- `demos/full_system_demo.py`
- `docs/QUICK_START.md`
- `config.demo.yaml`

---

### 🟠 中优先级 - 1-2周内

#### 3. 生产环境部署准备 ⭐⭐⭐

**当前状态**: 系统可以在开发环境运行，但缺少生产环境配置

**工作内容**:

##### 3.1 容器化部署
- [ ] 编写 `Dockerfile`
  - 基于 Python 3.10+ 镜像
  - 安装所有依赖
  - 配置环境变量
  - 设置工作目录和入口点
- [ ] 编写 `docker-compose.yml`
  - PerpBot 主服务
  - Redis（可选，用于缓存）
  - Prometheus（监控）
  - Grafana（可视化）
- [ ] 编写容器启动脚本 `scripts/docker-start.sh`
- [ ] 编写健康检查端点

##### 3.2 进程管理
- [ ] Supervisor 配置 `deploy/supervisor/perpbot.conf`
- [ ] PM2 配置 `deploy/pm2/ecosystem.config.js`
- [ ] 自动重启策略
- [ ] 优雅停机处理

##### 3.3 日志管理
- [ ] 配置 Logrotate `deploy/logrotate/perpbot`
- [ ] 日志分级存储（DEBUG/INFO/ERROR）
- [ ] 日志归档策略（保留 30 天）
- [ ] 集中日志收集（可选：ELK/Loki）

##### 3.4 监控告警
- [ ] Prometheus 指标导出
  - 订单成功率
  - 执行延迟
  - 资金使用率
  - 持仓敞口
  - 系统健康度
- [ ] Grafana Dashboard 配置
- [ ] 告警规则配置
  - 资金使用超过 80%
  - 执行延迟超过 500ms
  - 订单失败率超过 5%
  - 系统健康度低于 90

##### 3.5 故障恢复
- [ ] 断线重连机制（已有，需测试）
- [ ] 状态持久化与恢复
- [ ] 灾难恢复预案文档

##### 3.6 部署文档
- [ ] 部署检查清单 `docs/DEPLOYMENT_CHECKLIST.md`
- [ ] Runbook `docs/RUNBOOK.md`
  - 常见问题排查
  - 紧急操作流程
  - 系统维护指南

**价值**:
- 🎯 确保系统可以 24/7 稳定运行
- 🎯 快速发现和响应问题
- 🎯 降低运维成本

**工作量**: 2-3 天

**验收标准**:
- ✅ 系统可以通过 Docker 一键部署
- ✅ 有完整的监控面板
- ✅ 告警系统正常工作
- ✅ 部署文档完整清晰

---

#### 4. 性能压测与优化 ⭐⭐⭐

**当前状态**: 端到端延迟 110-190ms，未进行系统性压测

**工作内容**:

##### 4.1 压测工具开发
- [ ] 编写压测脚本 `tests/performance/load_test.py`
  - 模拟并发行情推送
  - 模拟并发订单提交
  - 模拟长时间运行

##### 4.2 性能指标测试
- [ ] 并发下单测试
  - 目标：100+ 订单/秒
  - 测量：下单成功率、延迟分布
- [ ] 行情处理吞吐测试
  - 目标：1000+ 更新/秒
  - 测量：处理延迟、丢包率
- [ ] 端到端延迟分析
  - 目标：< 200ms (P99)
  - 当前：110-190ms
  - 细分：网络延迟、处理延迟、数据库延迟
- [ ] 内存泄漏检测
  - 长时间运行（24 小时+）
  - 监控内存使用趋势

##### 4.3 性能优化
- [ ] 识别性能瓶颈
  - 使用 cProfile/line_profiler 分析
  - 识别热点代码路径
- [ ] 优化措施
  - 数据结构优化（使用 numpy/pandas）
  - 算法优化（减少重复计算）
  - 并发优化（asyncio/多线程）
  - 缓存优化（LRU cache）
- [ ] 验证优化效果

##### 4.4 压测报告
- [ ] 编写压测报告 `docs/PERFORMANCE_TEST_REPORT.md`
  - 测试环境说明
  - 测试场景和数据
  - 性能指标结果
  - 瓶颈分析
  - 优化建议

**价值**:
- 🎯 验证系统在高负载下的表现
- 🎯 发现潜在的性能瓶颈
- 🎯 为生产环境容量规划提供数据

**工作量**: 3-4 天

**验收标准**:
- ✅ 能够处理 100+ 订单/秒
- ✅ 行情处理延迟 < 100ms (P99)
- ✅ 端到端延迟 < 200ms (P99)
- ✅ 长时间运行无内存泄漏
- ✅ 有完整的压测报告

---

#### 5. 单元测试覆盖提升 ⭐⭐

**当前状态**: 主要是集成测试（47/48），单元测试覆盖率不足

**工作内容**:

##### 5.1 测试框架搭建
- [ ] 配置 pytest 和覆盖率工具
- [ ] 设置 Mock 框架（unittest.mock）
- [ ] 配置 CI/CD 自动测试

##### 5.2 核心模块单元测试
- [ ] EventBus 测试 `tests/unit/events/test_event_bus.py`
  - 事件发布/订阅
  - 异步处理
  - 错误处理
- [ ] RiskManager 测试 `tests/unit/test_risk_manager.py`
  - 资金风控规则
  - 账户风控规则
  - 仓位风控规则
  - 执行风控规则
- [ ] ExecutionEngine 测试 `tests/unit/execution/test_execution_engine.py`
  - 订单路由
  - 策略选择
  - 错误重试
- [ ] CapitalSystem 测试 `tests/unit/capital/test_capital_system.py`
  - 资金分配
  - 资金预留
  - 资金释放
- [ ] PositionAggregator 测试 `tests/unit/positions/test_position_aggregator.py`
  - 持仓聚合
  - 敞口计算
  - 持仓更新

##### 5.3 边界条件测试
- [ ] 空值/None 处理
- [ ] 异常输入（负数、超大数值）
- [ ] 并发访问（竞态条件）
- [ ] 资源耗尽（内存、连接）

##### 5.4 错误处理测试
- [ ] 网络错误
- [ ] API 错误（4xx/5xx）
- [ ] 超时处理
- [ ] 数据解析错误

##### 5.5 覆盖率报告
- [ ] 生成覆盖率报告
- [ ] 目标覆盖率：95%+
- [ ] 识别未覆盖的关键路径

**价值**:
- 🎯 提高代码质量和可维护性
- 🎯 减少回归问题
- 🎯 提升开发者信心

**工作量**: 3-5 天

**验收标准**:
- ✅ 单元测试覆盖率 > 95%
- ✅ 所有核心模块都有单元测试
- ✅ CI/CD 自动运行测试
- ✅ 测试文档完整

---

### 🟡 低优先级 - 1个月+

#### 6. 高级执行策略实现 ⭐⭐

**当前状态**: 只有基础的 Maker/Taker 策略

**工作内容**:

##### 6.1 TWAP（时间加权平均价格）
- [ ] 策略实现 `src/perpbot/strategy/twap_strategy.py`
- [ ] 订单拆分逻辑
- [ ] 时间调度器
- [ ] 策略配置参数

##### 6.2 VWAP（成交量加权平均价格）
- [ ] 策略实现 `src/perpbot/strategy/vwap_strategy.py`
- [ ] 历史成交量分析
- [ ] 动态订单大小调整
- [ ] 策略配置参数

##### 6.3 Iceberg 订单（冰山订单）
- [ ] 策略实现 `src/perpbot/strategy/iceberg_strategy.py`
- [ ] 订单隐藏逻辑
- [ ] 动态显示数量
- [ ] 策略配置参数

##### 6.4 POV（成交量百分比）策略
- [ ] 策略实现 `src/perpbot/strategy/pov_strategy.py`
- [ ] 实时成交量监控
- [ ] 动态参与率调整
- [ ] 策略配置参数

##### 6.5 策略回测框架
- [ ] 历史数据回放
- [ ] 策略性能评估
- [ ] 参数优化工具

**价值**:
- 🎯 优化大额订单的执行效果
- 🎯 减少市场冲击
- 🎯 提高成交率

**工作量**: 2-3 天/策略

**验收标准**:
- ✅ 每个策略都有完整实现
- ✅ 有策略配置文档
- ✅ 有回测验证
- ✅ 集成到执行引擎

---

#### 7. 多链跨链套利支持 ⭐

**当前状态**: 只支持同链内套利

**工作内容**:
- [ ] 跨链桥集成（LayerZero/Stargate/Wormhole）
- [ ] 跨链成本计算
- [ ] 跨链时间估算
- [ ] 跨链风险控制
- [ ] 跨链套利策略

**价值**:
- 🎯 发现更多套利机会
- 🎯 提高资金利用率

**工作量**: 5-7 天

---

#### 8. 机器学习成交概率预测 ⭐

**当前状态**: 成交概率基于简单规则

**工作内容**:
- [ ] 历史订单数据收集
- [ ] 特征工程（订单簿深度、价差、波动率等）
- [ ] 模型训练（XGBoost/LightGBM）
- [ ] 模型部署
- [ ] 在线学习更新

**价值**:
- 🎯 优化 Maker 订单成交率预测
- 🎯 提高策略执行效果

**工作量**: 1-2 周

---

## 💡 推荐实施策略

### 策略 A: 快速商业化（赚钱优先）

**目标**: 尽快验证系统的盈利能力

**推进路径**:
1. 真实数据集成（任务 1）
2. 生产部署准备（任务 3）
3. 性能压测（任务 4）

**时间线**: 1-2 周

**风险**: 需要投入真实资金测试

**适合场景**:
- 已有交易经验
- 有可投入的测试资金
- 追求快速 ROI

---

### 策略 B: 开源展示（社区优先）

**目标**: 吸引开发者和用户关注

**推进路径**:
1. 完整 Demo（任务 2）
2. 单元测试覆盖（任务 5）
3. 真实数据集成（任务 1）

**时间线**: 1-2 周

**优势**:
- 提升项目专业度
- 降低学习门槛
- 利于招募贡献者

**适合场景**:
- 打算开源项目
- 需要招募开发者
- 追求长期影响力

---

### 策略 C: 稳健运营（稳定性优先）

**目标**: 确保系统长期稳定运行

**推进路径**:
1. 生产部署准备（任务 3）
2. 性能压测（任务 4）
3. 单元测试覆盖（任务 5）
4. 真实数据集成（任务 1）

**时间线**: 2-3 周

**优势**:
- 稳扎稳打
- 降低风险
- 适合长期运营

**适合场景**:
- 追求系统稳定性
- 有充足的开发时间
- 风险厌恶型

---

### 策略 D: 快速验证（MVP 优先）

**目标**: 最快验证核心假设

**推进路径**:
1. 真实数据集成（只做 1-2 个交易所）
2. 手动运行测试（不做自动化部署）
3. 小资金验证套利逻辑

**时间线**: 2-3 天

**优势**:
- 快速验证
- 降低沉没成本
- 灵活调整方向

**适合场景**:
- 不确定市场可行性
- 时间/资源有限
- 探索性项目

---

## 🚀 推荐行动计划

基于项目当前状态（**99/100 验证分数**，核心功能已完成），**强烈推荐采用策略 A + B 的组合**：

### Week 1: 核心功能验证
- **Day 1-3**: 真实数据集成（从 Paradex + OKX 开始）
  - 接入 WebSocket 行情
  - 验证套利发现准确性
  - 记录性能指标
- **Day 4-5**: 编写完整 Demo
  - 实现端到端流程
  - 添加详细文档
  - 录制演示视频

### Week 2: 生产准备
- **Day 1-3**: 生产部署准备
  - Docker 容器化
  - 监控告警配置
  - 部署文档编写
- **Day 4-5**: 小资金实盘测试
  - 使用 testnet 或小额资金
  - 验证完整交易流程
  - 收集真实性能数据

### Week 3-4: 优化与完善（可选）
- 性能压测与优化
- 单元测试覆盖提升
- 根据实盘反馈调整策略

---

## 📈 里程碑定义

### Milestone 1: 真实数据就绪 (Week 1)
- ✅ Scanner V3 验证分数 100%
- ✅ 实时行情接入 3+ 交易所
- ✅ 能够发现真实套利机会
- ✅ 行情处理延迟 < 100ms

### Milestone 2: 系统可演示 (Week 1-2)
- ✅ 完整 Demo 可运行
- ✅ 快速入门文档完成
- ✅ 演示视频录制
- ✅ 新用户能在 30 分钟内上手

### Milestone 3: 生产就绪 (Week 2)
- ✅ Docker 部署可用
- ✅ 监控告警配置完成
- ✅ 部署文档和 Runbook 完成
- ✅ 通过 24 小时稳定性测试

### Milestone 4: 实盘验证 (Week 2-3)
- ✅ 完成小资金实盘测试
- ✅ 验证套利逻辑可行性
- ✅ 收集真实性能数据
- ✅ 形成优化建议

### Milestone 5: 系统优化 (Week 3-4)
- ✅ 性能压测完成
- ✅ 单元测试覆盖率 > 90%
- ✅ 性能优化完成
- ✅ 系统文档完善

---

## 🎯 成功指标

### 技术指标
- [ ] Scanner V3 验证分数 100%
- [ ] 单元测试覆盖率 > 95%
- [ ] 端到端延迟 < 200ms (P99)
- [ ] 订单成功率 > 99%
- [ ] 系统可用性 > 99.9%

### 业务指标
- [ ] 能够发现套利机会（每天 > 10 次）
- [ ] 套利执行成功率 > 80%
- [ ] 实际盈利能力验证（ROI > 0）

### 项目指标
- [ ] 文档完整度 > 95%
- [ ] 新用户上手时间 < 30 分钟
- [ ] 代码质量评分 > 90 (SonarQube)

---

## 📝 附录

### 相关文档
- [ARCHITECTURE.md](ARCHITECTURE.md) - 系统架构文档
- [README.md](README.md) - 项目概览
- [VALIDATION_FINAL_REPORT.md](VALIDATION_FINAL_REPORT.md) - 验证报告
- [DEVELOPING_GUIDE.md](DEVELOPING_GUIDE.md) - 开发规范

### 技术栈
- **语言**: Python 3.10+
- **异步框架**: asyncio
- **Web 框架**: FastAPI
- **数据库**: SQLite/PostgreSQL (可选)
- **监控**: Prometheus + Grafana
- **容器**: Docker + Docker Compose
- **进程管理**: Supervisor / PM2

### 团队技能要求
- Python 高级开发（必须）
- 交易系统经验（必须）
- WebSocket/异步编程（必须）
- Docker/DevOps（推荐）
- 前端开发（可选，用于 Dashboard）

---

**文档维护**: 本文档应随项目进展定期更新（建议每周更新一次）

**最后更新**: 2025-12-12
